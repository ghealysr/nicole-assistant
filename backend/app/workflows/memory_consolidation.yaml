# Memory Consolidation Workflow
# =============================
# 
# This workflow runs nightly to maintain Nicole's memory health:
# - Merge duplicate memories
# - Apply confidence decay to unused memories
# - Detect patterns and generate insights
# - Strengthen important relationships
#
# Schedule: 3 AM daily (low activity time)
# Duration: ~5-10 minutes
# 
# Author: Nicole V7 Workflow Engine

name: memory_consolidation
description: "Nightly memory maintenance, pattern detection, and insight generation"
version: "1.0.0"
schedule: "0 3 * * *"  # Daily at 3 AM

config:
  max_retries: 1
  timeout_seconds: 600  # 10 minutes max
  notify_on_failure: true

steps:
  # Step 1: Find and Merge Duplicate Memories
  - name: find_duplicates
    type: tool
    tool: memory_find_duplicates
    params:
      similarity_threshold: 0.85
      
  - name: merge_duplicates
    type: tool
    tool: memory_merge_duplicates
    depends_on: [find_duplicates]
    params:
      duplicates: "{{steps.find_duplicates.result}}"
      strategy: "keep_highest_confidence"
      
  # Step 2: Apply Confidence Decay
  - name: apply_decay
    type: tool
    tool: memory_apply_decay
    params:
      decay_rate: 0.02  # 2% decay for unused memories
      protected_tags: ["important", "family", "identity"]
      min_age_days: 7  # Only decay memories older than 7 days
      
  # Step 3: Strengthen Active Relationships
  - name: strengthen_relationships
    type: tool
    tool: memory_relationship_maintenance
    params:
      boost_frequently_accessed: true
      prune_weak_links: true
      min_confidence_for_pruning: 0.2
      
  # Step 4: Detect Patterns Across Memories
  - name: detect_patterns
    type: tool
    tool: memory_pattern_detection
    depends_on: [apply_decay]
    params:
      lookback_days: 30
      min_pattern_occurrences: 3
      categories: ["preference", "behavior", "relationship", "workflow"]
      
  # Step 5: Generate Insights from Patterns
  - name: generate_insights
    type: agent
    agent: nicole_core
    depends_on: [detect_patterns]
    prompt: |
      Analyze these patterns detected in Glen's memory and generate insights:
      
      ## Detected Patterns
      {{steps.detect_patterns.result}}
      
      For each significant pattern:
      1. What does it reveal about Glen's preferences, habits, or needs?
      2. Is there an actionable insight I should remember?
      3. Should I proactively mention this to Glen?
      
      Generate 1-3 high-value insights that would help me serve Glen better.
      Be specific and actionable, not generic.
      
      Format as a list of insights with:
      - Insight text
      - Confidence (how certain I am)
      - Should I mention to Glen (yes/no)
      - Suggested action (if any)

  # Step 6: Store Generated Insights
  - name: store_insights
    type: tool
    tool: memory_store_batch
    depends_on: [generate_insights]
    params:
      memories: "{{steps.generate_insights.result}}"
      memory_type: "insight"
      tags: ["generated", "pattern", "consolidation"]
      
  # Step 7: Archive Old Low-Confidence Memories
  - name: archive_old_memories
    type: tool
    tool: memory_archive
    depends_on: [apply_decay]
    params:
      max_age_days: 180
      max_confidence: 0.3
      exclude_tags: ["important", "family", "identity", "permanent"]
      
  # Step 8: Generate Consolidation Report
  - name: generate_report
    type: agent
    agent: nicole_core
    depends_on:
      - merge_duplicates
      - apply_decay
      - strengthen_relationships
      - store_insights
      - archive_old_memories
    prompt: |
      Create a brief memory consolidation report for the night of {{now.date}}:
      
      ## Actions Taken
      - Duplicates merged: {{steps.merge_duplicates.result.count}}
      - Decay applied to: {{steps.apply_decay.result.affected_count}} memories
      - Relationships strengthened: {{steps.strengthen_relationships.result.strengthened}}
      - Weak links pruned: {{steps.strengthen_relationships.result.pruned}}
      - Insights generated: {{steps.store_insights.result.count}}
      - Memories archived: {{steps.archive_old_memories.result.archived_count}}
      
      Summarize in 2-3 sentences what this maintenance achieved.
      Note any concerns (e.g., too many memories decaying, patterns of confusion).

  # Step 9: Log Report
  - name: log_report
    type: tool
    tool: memory_store
    depends_on: [generate_report]
    params:
      content: "{{steps.generate_report.result}}"
      memory_type: "system"
      tags: ["consolidation", "report", "{{now.date}}"]
      importance: "low"

on_success:
  - type: notify
    channel: log
    message: "Memory consolidation completed for {{now.date}}"

on_failure:
  - type: notify
    channel: log
    message: "Memory consolidation failed: {{error}}"

